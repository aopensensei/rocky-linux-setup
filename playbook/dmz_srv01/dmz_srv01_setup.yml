- name: Setup DMZ server for WordPress and EC-Cube
  hosts: dmz
  become: yes

  vars:
    mariadb_root_password: "Hard-ing0"
    user_password: "Hard-ing0"
    users:
      - user01
      - user02
      - user03
      - user04
      - user05
      - user06
      - user07
      - user08
      - user09
      - user10
    eccube_version: "4.2.3"
    php_version: "7.4"

  tasks:
    # 0. Set timezone to Asia/Tokyo
    - name: Set timezone to Asia/Tokyo
      command: timedatectl set-timezone Asia/Tokyo

    # 1. Add users
    - name: Create users with default skel
      user:
        name: "{{ item }}"
        password: "{{ user_password | password_hash('sha512') }}"
        state: present
        create_home: yes
        shell: /bin/bash
      loop: "{{ users }}"

    - name: Add users to sudo group
      user:
        name: "{{ item }}"
        groups: wheel
        append: yes
      loop: "{{ users }}"

    # 2. Install EPEL repository
    - name: Install EPEL repository
      yum:
        name: epel-release
        state: present

    # 3. Import Remi GPG key
    - name: Import Remi GPG key
      rpm_key:
        state: present
        key: https://rpms.remirepo.net/RPM-GPG-KEY-remi

    # 4. Install Remi repository
    - name: Install Remi repository
      yum:
        name: https://rpms.remirepo.net/enterprise/remi-release-9.rpm
        state: present

    # 5. Install DNF utils
    - name: Install DNF utils
      yum:
        name: dnf-utils
        state: present

    # 6. Reset PHP module
    - name: Reset PHP module
      shell: dnf module reset php -y
      args:
        warn: false

    # 7. Enable PHP 7.4 module
    - name: Enable PHP 7.4 module
      shell: dnf module enable php:remi-7.4 -y
      args:
        warn: false

    # 8. Install required packages
    - name: Install required packages
      yum:
        name:
          - nginx
          - mariadb-server
          - python3
          - python3-PyMySQL
          - php
          - php-fpm
          - php-mysqlnd
          - php-gd
          - unzip
          - tar
        state: present

    # 9. Install additional PHP modules
    - name: Install additional PHP modules
      yum:
        name:
          - php-mbstring
          - php-xml
          - php-pdo
          - php-intl
          - php-opcache
          - php-zip
          - php-json
          - php-curl
        state: present

    # 10. Stop and disable firewalld
    - name: Stop and disable firewalld for unrestricted access
      service:
        name: firewalld
        state: stopped
        enabled: no

    # 11. Start and enable services
    - name: Start and enable services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - nginx
        - mariadb
        - php-fpm

    # 12. MariaDB configuration
    - name: Change root authentication plugin to mysql_native_password
      mysql_user:
        name: root
        host: localhost
        password: "{{ mariadb_root_password }}"
        login_unix_socket: /var/lib/mysql/mysql.sock
        plugin: mysql_native_password
        priv: '*.*:ALL,GRANT'
        state: present

    - name: Create databases for WordPress and EC-Cube
      mysql_db:
        name: "{{ item }}"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"
      loop:
        - wordpress_db
        - eccube_db

    - name: Configure MariaDB users
      mysql_user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        priv: "{{ item.db }}.*:ALL"
        host: localhost
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        state: present
      loop:
        - { name: 'admin', password: 'Hard-ing0', db: 'wordpress_db' }
        - { name: 'admin', password: 'Hard-ing0000', db: 'eccube_db' }

    # 13. WordPress installation
    - name: Download WordPress
      get_url:
        url: https://ja.wordpress.org/latest-ja.tar.gz
        dest: /tmp/latest-ja.tar.gz
        force: no

    - name: Extract WordPress
      unarchive:
        src: /tmp/latest-ja.tar.gz
        dest: /var/www/html/
        remote_src: yes

    - name: Set permissions for WordPress
      file:
        path: /var/www/html/
        owner: nginx
        group: nginx
        recurse: yes

    # 14. EC-Cube installation
    - name: Create directory for EC-Cube
      file:
        path: /var/www/html/shop
        state: directory
        owner: nginx
        group: nginx

    - name: Download EC-CUBE
      get_url:
        url: "https://downloads.ec-cube.net/src/eccube-{{ eccube_version }}.tar.gz"
        dest: /tmp/eccube.tar.gz
        force: no

    - name: Extract EC-CUBE
      unarchive:
        src: /tmp/eccube.tar.gz
        dest: /var/www/html/shop
        remote_src: yes

    - name: Set permissions for EC-Cube
      file:
        path: /var/www/html/shop/
        owner: nginx
        group: nginx
        recurse: yes

    # 15. Configure Nginx
    - name: Configure Nginx for WordPress and EC-Cube
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      notify:
        - Restart nginx

    # 16. Ensure PHP-FPM is running
    - name: Ensure PHP-FPM is running
      service:
        name: php-fpm
        state: started
        enabled: yes

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted

    - name: Restart mariadb
      service:
        name: mariadb
        state: restarted
